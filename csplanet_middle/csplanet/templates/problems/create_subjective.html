{# templates/problems/create_subjective.html #}
{% extends "base.html" %}

{% block title %}주관식 문제 출제하기 - Tok! CS{% endblock %}

{% block content %}
<div class="container my-5">
  <h2 class="mb-4">주관식 문제 출제하기</h2>
  <form method="post" id="subjective-form">
    {% csrf_token %}

    {# — 전역 에러 — #}
    {{ form.non_field_errors }}
    {{ formset.non_form_errors }}

    {# management form (prefix='kw') #}
    {{ formset.management_form }}

    <!-- Topic / Chapter -->
    <div class="mb-3">
      <label for="topic" class="form-label">Topic 선택</label>
      <select id="topic" class="form-select">
        <option value="">-- Topic 선택 --</option>
        {% for topic in topics %}
          <option value="{{ topic.id }}">{{ topic.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="mb-3">
      <label for="id_chapter" class="form-label">Chapter 선택</label>
      <select id="id_chapter" name="chapter" class="form-select" required>
        <option value="">-- Chapter 선택 --</option>
        {% for ch in chapters %}
          <option value="{{ ch.id }}" data-topic="{{ ch.topic_id }}"
            {% if form.chapter.value|stringformat:'s' == ch.id|stringformat:'s' %}selected{% endif %}>
            {{ ch.name }}
          </option>
        {% endfor %}
      </select>
      {% for err in form.chapter.errors %}
        <div class="text-danger small">{{ err }}</div>
      {% endfor %}
    </div>

    <!-- 문제·해설·배점 -->
    <div class="mb-3">
      {{ form.content.label_tag }}<br>
      {{ form.content }}
      {% for err in form.content.errors %}
        <div class="text-danger small">{{ err }}</div>
      {% endfor %}
    </div>
    <div class="mb-3">
      {{ form.explanation.label_tag }}<br>
      {{ form.explanation }}
      {% for err in form.explanation.errors %}
        <div class="text-danger small">{{ err }}</div>
      {% endfor %}
    </div>
    <div class="mb-3">
      {{ form.score.label_tag }}<br>
      {{ form.score }}
      {% for err in form.score.errors %}
        <div class="text-danger small">{{ err }}</div>
      {% endfor %}
    </div>

    <!-- 키워드 폼셋 -->
    <h4 class="mt-4">채점용 키워드 & 중요도</h4>
    <table class="table table-borderless align-middle">
      <thead>
        <tr>
          <th>키워드</th>
          <th class="text-center" style="width:110px">중요도</th>
          <th class="text-center" style="width:100px">삭제</th>
        </tr>
      </thead>
      <tbody id="kw-body">
        {% for fs in formset %}
        <tr class="kw-row">
          <td>
            {{ fs.keyword }}
            {% for err in fs.keyword.errors %}
              <div class="text-danger small">{{ err }}</div>
            {% endfor %}
          </td>
          <td class="text-center">
            {{ fs.importance }}
            {% for err in fs.importance.errors %}
              <div class="text-danger small">{{ err }}</div>
            {% endfor %}
          </td>
          <td class="text-center">
            {{ fs.DELETE }}
            <button type="button" class="btn btn-sm btn-outline-danger delete-row">삭제</button>
          </td>
        </tr>
        {% endfor %}
        <tr id="kw-tpl" class="kw-row" style="display:none">
          <td>
            {{ formset.empty_form.keyword }}
          </td>
          <td class="text-center">
            {{ formset.empty_form.importance }}
          </td>
          <td class="text-center">
            {{ formset.empty_form.DELETE }}
            <button type="button" class="btn btn-sm btn-outline-danger delete-row">삭제</button>
          </td>
        </tr>
      </tbody>
    </table>
    <button type="button" id="add-kw" class="btn btn-outline-secondary mb-4">
      키워드 추가하기
    </button>

    <div class="d-flex justify-content-between">
      <button type="submit" name="submit_type" value="continue" class="btn btn-warning">
        이어서 계속 작성
      </button>
      <button type="submit" name="submit_type" value="finish" class="btn btn-primary">
        문제 제출하기
      </button>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  const body  = document.getElementById("kw-body");
  const total = document.querySelector('input[name="kw-TOTAL_FORMS"]');
  const MIN = 1, MAX = 7;

  // 키워드 추가: 보이는 행 기준 MAX 체크
  document.getElementById("add-kw").addEventListener("click", () => {
    const visible = Array.from(body.querySelectorAll(".kw-row:not(#kw-tpl)"))
                         .filter(r => window.getComputedStyle(r).display !== 'none');
    if (visible.length >= MAX) {
      return alert(`최대 ${MAX}개까지만 추가할 수 있습니다.`);
    }
    const count = +total.value;
    const tpl   = document.getElementById("kw-tpl").cloneNode(true);
    tpl.removeAttribute("id");
    tpl.style.display = "";
    tpl.classList.add("kw-row");
    tpl.innerHTML = tpl.innerHTML.replace(/__prefix__/g, count);
    total.value = count + 1;
    body.appendChild(tpl);
  });

  // 키워드 삭제: 보이는 행 기준 MIN 체크
  body.addEventListener("click", e => {
    if (!e.target.classList.contains("delete-row")) return;
    const visible = Array.from(body.querySelectorAll(".kw-row:not(#kw-tpl)"))
                         .filter(r => window.getComputedStyle(r).display !== 'none');
    if (visible.length <= MIN) {
      return alert(`최소 ${MIN}개의 키워드가 필요합니다.`);
    }
    const row = e.target.closest(".kw-row");
    row.querySelector('input[name$="-DELETE"]').checked = true;
    row.style.display = 'none';
  });
})();
</script>
{% endblock %}
